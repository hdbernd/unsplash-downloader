<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Unsplash Collection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .settings-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .settings-card:hover {
            transform: translateY(-2px);
        }
        .settings-section {
            padding: 20px;
        }
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .history-item {
            padding: 8px 12px;
            margin: 2px 0;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        .history-item:hover {
            background: #f8f9fa;
        }
        .badge-setting {
            font-size: 0.8em;
        }
        .setting-group {
            margin-bottom: 1.5rem;
        }
        .setting-label {
            font-weight: 600;
            color: #495057;
        }
        .setting-value {
            font-family: monospace;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .folder-browser {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .folder-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .folder-item:hover {
            background-color: #f8f9fa;
        }
        .folder-item:last-child {
            border-bottom: none;
        }
        .folder-item i {
            margin-right: 8px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-camera"></i> Unsplash Collection
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/download">Download</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/popular">Popular</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/stats">Statistics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api-keys">API Keys</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/settings">Settings</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mt-4">
        <h2><i class="bi bi-gear"></i> Application Settings</h2>
        
        <!-- Settings Form -->
        <div class="row">
            <div class="col-lg-8">
                <div class="settings-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-sliders"></i> User Preferences</h5>
                    </div>
                    <div class="card-body settings-section">
                        <form id="settingsForm">
                            <div class="form-section">
                                <h6 class="mb-3"><i class="bi bi-person"></i> Default Download Settings</h6>
                                
                                <div class="setting-group">
                                    <label for="lastUsername" class="form-label setting-label">Default Username</label>
                                    <input type="text" class="form-control setting-value" id="lastUsername" 
                                           th:value="${settings.lastUsername}" 
                                           placeholder="Enter default Unsplash username">
                                    <div class="form-text">The default username that will be pre-filled in the download form</div>
                                </div>
                                
                                <div class="setting-group">
                                    <label for="lastOutputPath" class="form-label setting-label">Default Output Path</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control setting-value" id="lastOutputPath" 
                                               th:value="${settings.lastOutputPath}" 
                                               placeholder="Enter default output directory">
                                        <button class="btn btn-outline-secondary" type="button" id="browsePathBtn">
                                            <i class="bi bi-folder"></i> Browse
                                        </button>
                                    </div>
                                    <div class="form-text">The default directory where photos will be downloaded</div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h6 class="mb-3"><i class="bi bi-database"></i> Database Synchronization</h6>
                                
                                <div class="setting-group">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label setting-label">Network Drive Sync</label>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-info btn-sm" id="syncStatusBtn">
                                                <i class="bi bi-info-circle"></i> Status
                                            </button>
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="syncToNetworkBtn">
                                                <i class="bi bi-cloud-upload"></i> Sync to Network
                                            </button>
                                            <button type="button" class="btn btn-outline-warning btn-sm" id="restoreFromNetworkBtn">
                                                <i class="bi bi-cloud-download"></i> Restore from Network
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-text">
                                        Automatically synchronizes local database with network drive for reliability. 
                                        Local database provides fast performance while maintaining network backup.
                                        Database syncs to network every minute and on application shutdown.
                                    </div>
                                    <div id="syncStatusDisplay" class="mt-2" style="display: none;">
                                        <div class="alert alert-info">
                                            <div id="syncStatusContent">Loading sync status...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h6 class="mb-3"><i class="bi bi-file-earmark-text"></i> Metadata Sync</h6>
                                
                                <div class="setting-group">
                                    <div class="alert alert-info">
                                        <strong><i class="bi bi-info-circle"></i> About Metadata Sync:</strong> 
                                        This feature writes photo descriptions, tags, and photographer information directly into the EXIF metadata of your downloaded JPEG images. 
                                        This makes the information available in any photo viewer or editing software.
                                    </div>
                                    
                                    <!-- Sync Statistics -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6 class="card-title">Overview</h6>
                                                    <div class="row text-center mb-3" id="metadataSyncOverview">
                                                        <div class="col-3">
                                                            <div class="h5 text-primary mb-0" id="totalPhotosInDatabase">--</div>
                                                            <small class="text-muted">Total Photos</small>
                                                        </div>
                                                        <div class="col-3">
                                                            <div class="h5 text-success mb-0" id="completedCount">--</div>
                                                            <small class="text-muted">Synced</small>
                                                        </div>
                                                        <div class="col-3">
                                                            <div class="h5 text-warning mb-0" id="photosDueForSync">--</div>
                                                            <small class="text-muted">Due for Sync</small>
                                                        </div>
                                                        <div class="col-3">
                                                            <div class="h5 text-info mb-0" id="photosNotInSync">--</div>
                                                            <small class="text-muted">Not in Sync System</small>
                                                        </div>
                                                    </div>
                                                    
                                                    <h6 class="card-title">Detailed Stats</h6>
                                                    <div class="row text-center" id="metadataSyncStats">
                                                        <div class="col-2">
                                                            <div class="h6 text-secondary mb-0" id="totalInSync">--</div>
                                                            <small class="text-muted">In Sync System</small>
                                                        </div>
                                                        <div class="col-2">
                                                            <div class="h6 text-warning mb-0" id="pendingCount">--</div>
                                                            <small class="text-muted">Pending</small>
                                                        </div>
                                                        <div class="col-2">
                                                            <div class="h6 text-danger mb-0" id="failedCount">--</div>
                                                            <small class="text-muted">Failed</small>
                                                        </div>
                                                        <div class="col-2">
                                                            <div class="h6 text-danger mb-0" id="errorCount">--</div>
                                                            <small class="text-muted">Error</small>
                                                        </div>
                                                        <div class="col-2">
                                                            <div class="h6 text-muted mb-0" id="skippedCount">--</div>
                                                            <small class="text-muted">Skipped</small>
                                                        </div>
                                                        <div class="col-2">
                                                            <div class="h6 text-primary mb-0" id="inProgressCount">--</div>
                                                            <small class="text-muted">In Progress</small>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="mt-3">
                                                        <div class="progress" style="height: 10px;">
                                                            <div class="progress-bar bg-success" id="syncProgressBar" style="width: 0%"></div>
                                                        </div>
                                                        <div class="d-flex justify-content-between mt-1">
                                                            <small class="text-muted">Overall Progress: <span id="overallCompletionPercentage">0%</span></small>
                                                            <small class="text-muted">Sync System: <span id="completionPercentage">0%</span></small>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2">
                                                        <small class="text-muted" id="syncStatusText">Ready</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Sync Controls -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Batch Size</label>
                                            <select class="form-select" id="batchSizeSelect">
                                                <option value="50">50 photos</option>
                                                <option value="100" selected>100 photos</option>
                                                <option value="200">200 photos</option>
                                                <option value="500">500 photos</option>
                                            </select>
                                            <div class="form-text">Number of photos to process in each batch</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Actions</label>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-primary" id="initializeBtn">
                                                    <i class="bi bi-plus-circle"></i> Initialize Sync
                                                </button>
                                                <button class="btn btn-outline-info" id="addNewPhotosBtn">
                                                    <i class="bi bi-plus-square"></i> Add New Photos
                                                </button>
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-success" id="startSyncBtn">
                                                        <i class="bi bi-play-circle"></i> Start Sync
                                                    </button>
                                                    <button class="btn btn-warning" id="stopSyncBtn" disabled>
                                                        <i class="bi bi-stop-circle"></i> Stop
                                                    </button>
                                                    <button class="btn btn-outline-secondary" id="refreshStatsBtn">
                                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <div class="form-text">
                                            <strong>Initialize Sync:</strong> Set up sync for all photos in database<br>
                                            <strong>Add New Photos:</strong> Add recently downloaded photos to sync system<br>
                                            <strong>Start Sync:</strong> Begin processing photos with metadata embedding
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <details class="mb-2">
                                            <summary class="btn btn-outline-info btn-sm">Advanced Options</summary>
                                            <div class="mt-2">
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-outline-warning btn-sm" id="resetSyncBtn">
                                                        <i class="bi bi-arrow-clockwise"></i> Reset All to Pending
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm" id="cleanupBtn">
                                                        <i class="bi bi-trash"></i> Cleanup Old Entries
                                                    </button>
                                                </div>
                                                <div class="form-text mt-1">
                                                    Reset: Mark all photos as pending for re-sync<br>
                                                    Cleanup: Remove completed entries older than 30 days
                                                </div>
                                            </div>
                                        </details>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h6 class="mb-3"><i class="bi bi-exclamation-triangle text-danger"></i> Danger Zone</h6>
                                
                                <div class="setting-group">
                                    <div class="alert alert-warning">
                                        <strong><i class="bi bi-exclamation-triangle"></i> Warning:</strong> These operations are irreversible and will permanently delete all data!
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label setting-label">Reset Storage</label>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-danger btn-sm" id="resetLocalBtn">
                                                <i class="bi bi-trash"></i> Reset Local Only
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm" id="resetAllBtn">
                                                <i class="bi bi-trash3"></i> Reset Everything
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-text">
                                        <strong>Reset Local Only:</strong> Deletes local database, photos cache, logs, and settings.<br>
                                        <strong>Reset Everything:</strong> Deletes ALL data from both local storage and network drive.
                                        This includes all downloaded photos, database, API keys, logs, and settings.
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label setting-label">Application Control</label>
                                        <button type="button" class="btn btn-outline-danger btn-sm" id="shutdownAppBtn">
                                            <i class="bi bi-power"></i> Shutdown Application
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        Gracefully shutdown the application. This will trigger proper database sync and cleanup procedures.
                                        The web interface will become unavailable until you restart the application.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h6 class="mb-3"><i class="bi bi-tags"></i> Tag Management</h6>
                                
                                <div class="setting-group">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label setting-label">Photo Tags</label>
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="refreshAllTagsBtn">
                                            <i class="bi bi-arrow-clockwise"></i> Refresh Missing Tags
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        Refresh tags for photos that don't have any tags by fetching metadata from Unsplash API.
                                        This is useful for photos downloaded before tag support was implemented.
                                    </div>
                                    <div id="tagRefreshStatus" class="mt-2" style="display: none;">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 id="tagRefreshProgress" role="progressbar" 
                                                 style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                        <small class="text-muted" id="tagRefreshText">Preparing...</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h6 class="mb-3"><i class="bi bi-toggles"></i> Application Behavior</h6>
                                
                                <div class="setting-group">
                                    <label for="defaultPageSize" class="form-label setting-label">Default Page Size</label>
                                    <select class="form-select setting-value" id="defaultPageSize">
                                        <option value="12" th:selected="${settings.defaultPageSize == 12}">12 photos per page</option>
                                        <option value="24" th:selected="${settings.defaultPageSize == 24}">24 photos per page</option>
                                        <option value="48" th:selected="${settings.defaultPageSize == 48}">48 photos per page</option>
                                        <option value="96" th:selected="${settings.defaultPageSize == 96}">96 photos per page</option>
                                    </select>
                                    <div class="form-text">Number of photos to display per page in the gallery</div>
                                </div>
                                
                                <div class="setting-group">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoSaveSettings" 
                                               th:checked="${settings.autoSaveSettings}">
                                        <label class="form-check-label setting-label" for="autoSaveSettings">
                                            Auto-save Settings
                                        </label>
                                        <div class="form-text">Automatically save settings when they change</div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showDetailedProgress" 
                                               th:checked="${settings.showDetailedProgress}">
                                        <label class="form-check-label setting-label" for="showDetailedProgress">
                                            Show Detailed Progress
                                        </label>
                                        <div class="form-text">Display detailed progress information during downloads</div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="confirmBeforeDownload" 
                                               th:checked="${settings.confirmBeforeDownload}">
                                        <label class="form-check-label setting-label" for="confirmBeforeDownload">
                                            Confirm Before Download
                                        </label>
                                        <div class="form-text">Ask for confirmation before starting downloads</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-outline-secondary" id="resetBtn">
                                    <i class="bi bi-arrow-clockwise"></i> Reset to Defaults
                                </button>
                                <button type="submit" class="btn btn-primary" id="saveBtn">
                                    <i class="bi bi-check-circle"></i> Save Settings
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Settings Info -->
            <div class="col-lg-4">
                <div class="settings-card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Current Settings</h5>
                    </div>
                    <div class="card-body settings-section">
                        <div class="setting-group">
                            <div class="setting-label">Last Username</div>
                            <div class="setting-value" th:text="${settings.lastUsername ?: 'Not set'}">Not set</div>
                        </div>
                        
                        <div class="setting-group">
                            <div class="setting-label">Last Output Path</div>
                            <div class="setting-value" th:text="${settings.lastOutputPath ?: 'Not set'}">Not set</div>
                        </div>
                        
                        <div class="setting-group">
                            <div class="setting-label">Page Size</div>
                            <div class="setting-value" th:text="${settings.defaultPageSize + ' photos'}">24 photos</div>
                        </div>
                        
                        <div class="setting-group">
                            <div class="setting-label">Auto-save</div>
                            <span class="badge badge-setting" th:class="${settings.autoSaveSettings ? 'badge bg-success' : 'badge bg-secondary'}" 
                                  th:text="${settings.autoSaveSettings ? 'Enabled' : 'Disabled'}">Enabled</span>
                        </div>
                        
                        <div class="setting-group">
                            <div class="setting-label">Detailed Progress</div>
                            <span class="badge badge-setting" th:class="${settings.showDetailedProgress ? 'badge bg-success' : 'badge bg-secondary'}" 
                                  th:text="${settings.showDetailedProgress ? 'Enabled' : 'Disabled'}">Enabled</span>
                        </div>
                        
                        <div class="setting-group">
                            <div class="setting-label">Confirm Downloads</div>
                            <span class="badge badge-setting" th:class="${settings.confirmBeforeDownload ? 'badge bg-warning' : 'badge bg-secondary'}" 
                                  th:text="${settings.confirmBeforeDownload ? 'Enabled' : 'Disabled'}">Disabled</span>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Items -->
                <div class="settings-card mt-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Items</h5>
                    </div>
                    <div class="card-body settings-section">
                        <div class="mb-3">
                            <h6 class="setting-label">Recent Usernames</h6>
                            <div th:if="${#lists.isEmpty(settings.recentUsernames)}" class="text-muted fst-italic">
                                No recent usernames
                            </div>
                            <div th:each="username : ${settings.recentUsernames}" class="history-item">
                                <span th:text="${username}">username</span>
                                <button class="btn btn-sm btn-outline-danger ms-auto" 
                                        onclick="removeRecentUsername(this)" 
                                        th:data-username="${username}">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6 class="setting-label">Recent Paths</h6>
                            <div th:if="${#lists.isEmpty(settings.recentOutputPaths)}" class="text-muted fst-italic">
                                No recent paths
                            </div>
                            <div th:each="path : ${settings.recentOutputPaths}" class="history-item">
                                <span th:text="${path}" class="text-truncate">path</span>
                                <button class="btn btn-sm btn-outline-danger ms-auto" 
                                        onclick="removeRecentPath(this)" 
                                        th:data-path="${path}">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button class="btn btn-outline-warning btn-sm" id="clearHistoryBtn">
                                <i class="bi bi-trash"></i> Clear All History
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Folder Browser Modal -->
    <div class="modal fade" id="folderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-folder"></i> Select Output Directory
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Current Path:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="currentPath" readonly>
                            <button class="btn btn-outline-secondary" id="parentBtn" title="Go to parent directory">
                                <i class="bi bi-arrow-up"></i> Parent
                            </button>
                            <button class="btn btn-outline-primary" id="newFolderBtn" title="Create new folder">
                                <i class="bi bi-folder-plus"></i> New Folder
                            </button>
                            <button class="btn btn-outline-success" id="refreshBtn" title="Refresh directory">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <!-- Breadcrumb Navigation -->
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb" id="breadcrumbNav">
                            <li class="breadcrumb-item"><a href="#" onclick="browsePath('/')">Root</a></li>
                        </ol>
                    </nav>
                    
                    <!-- Folder Browser -->
                    <div class="folder-browser" id="folderBrowser">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">Loading directories...</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="selectFolderBtn">
                        <i class="bi bi-check-circle"></i> Select This Folder
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Folder Modal -->
    <div class="modal fade" id="newFolderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-folder-plus"></i> Create New Folder
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newFolderName" class="form-label">Folder Name:</label>
                        <input type="text" class="form-control" id="newFolderName" 
                               placeholder="Enter folder name" maxlength="255">
                        <div class="form-text">
                            The folder will be created in: <span id="newFolderPath"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createFolderBtn">
                        <i class="bi bi-folder-plus"></i> Create Folder
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Unsplash Photo Collection</h5>
                    <p class="mb-0">A local mirror of your Unsplash photos with search and browsing capabilities.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">
                        <i class="bi bi-github"></i> 
                        <a href="https://github.com/your-repo" class="text-light">GitHub</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Save settings
        document.getElementById('settingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('lastUsername', document.getElementById('lastUsername').value);
            formData.append('lastOutputPath', document.getElementById('lastOutputPath').value);
            formData.append('defaultPageSize', document.getElementById('defaultPageSize').value);
            formData.append('autoSaveSettings', document.getElementById('autoSaveSettings').checked);
            formData.append('showDetailedProgress', document.getElementById('showDetailedProgress').checked);
            formData.append('confirmBeforeDownload', document.getElementById('confirmBeforeDownload').checked);
            
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Saving...';
            
            fetch('/settings/update', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Settings saved successfully!', 'success');
                    // Reload page to show updated settings
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showAlert('Failed to save settings: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to save settings', 'danger');
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Save Settings';
            });
        });
        
        // Reset settings
        document.getElementById('resetBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to reset all settings to their default values?')) {
                fetch('/settings/reset', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Settings reset successfully!', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showAlert('Failed to reset settings: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Failed to reset settings', 'danger');
                });
            }
        });
        
        // Clear history
        document.getElementById('clearHistoryBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all recent usernames and paths?')) {
                fetch('/settings/clear-history', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('History cleared successfully!', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showAlert('Failed to clear history: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Failed to clear history', 'danger');
                });
            }
        });
        
        // Refresh all missing tags
        document.getElementById('refreshAllTagsBtn').addEventListener('click', function() {
            if (confirm('This will fetch tags from Unsplash API for all photos that don\'t have any tags. This may take some time and use API requests. Continue?')) {
                const refreshBtn = document.getElementById('refreshAllTagsBtn');
                const statusDiv = document.getElementById('tagRefreshStatus');
                const progressBar = document.getElementById('tagRefreshProgress');
                const statusText = document.getElementById('tagRefreshText');
                
                // Show loading state
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Processing...';
                statusDiv.style.display = 'block';
                progressBar.style.width = '0%';
                statusText.textContent = 'Starting tag refresh process...';
                
                fetch('/api/photos/refresh-missing-tags', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        progressBar.style.width = '100%';
                        progressBar.classList.remove('progress-bar-animated');
                        statusText.textContent = data.message;
                        
                        showAlert('Tag refresh completed! ' + data.message, 'success');
                        
                        // Hide status after delay
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                        }, 3000);
                    } else {
                        progressBar.classList.remove('progress-bar-animated');
                        progressBar.classList.add('bg-danger');
                        statusText.textContent = 'Failed: ' + data.message;
                        showAlert('Failed to refresh tags: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                    statusText.textContent = 'Error occurred during tag refresh';
                    showAlert('Failed to refresh tags. Please try again.', 'danger');
                })
                .finally(() => {
                    // Reset button state
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Missing Tags';
                });
            }
        });

        // Database sync functionality
        document.getElementById('syncStatusBtn').addEventListener('click', function() {
            const statusDiv = document.getElementById('syncStatusDisplay');
            const contentDiv = document.getElementById('syncStatusContent');
            
            if (statusDiv.style.display === 'none') {
                statusDiv.style.display = 'block';
                contentDiv.innerHTML = 'Loading sync status...';
                
                fetch('/api/database-sync/status')
                .then(response => response.json())
                .then(data => {
                    let statusHtml = '';
                    
                    if (data.syncEnabled) {
                        statusHtml = `
                            <strong>Database Synchronization Status</strong><br>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <strong>Local Database:</strong><br>
                                    Path: <code>${data.localDbPath}</code><br>
                                    Exists: <span class="badge ${data.localDbExists ? 'bg-success' : 'bg-warning'}">${data.localDbExists ? 'Yes' : 'No'}</span><br>
                                    ${data.localDbLastModified ? `Last Modified: ${new Date(data.localDbLastModified).toLocaleString()}` : ''}
                                </div>
                                <div class="col-md-6">
                                    <strong>Network Database:</strong><br>
                                    Path: <code>${data.networkDbPath}</code><br>
                                    Exists: <span class="badge ${data.networkDbExists ? 'bg-success' : 'bg-warning'}">${data.networkDbExists ? 'Yes' : 'No'}</span><br>
                                    ${data.networkDbLastModified ? `Last Modified: ${new Date(data.networkDbLastModified).toLocaleString()}` : ''}
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Database is automatically synced to network every minute and on shutdown
                                </small>
                            </div>
                        `;
                    } else {
                        statusHtml = '<strong>Database sync is disabled</strong> - using local storage only';
                    }
                    
                    contentDiv.innerHTML = statusHtml;
                })
                .catch(error => {
                    contentDiv.innerHTML = 'Error loading sync status: ' + error.message;
                });
            } else {
                statusDiv.style.display = 'none';
            }
        });

        document.getElementById('syncToNetworkBtn').addEventListener('click', function() {
            if (confirm('Force sync local database to network drive now?')) {
                const btn = this;
                const originalText = btn.innerHTML;
                
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Syncing...';
                
                fetch('/api/database-sync/sync-to-network', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(data.message, 'success');
                    } else {
                        showAlert(data.message, 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Failed to sync to network: ' + error.message, 'danger');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
            }
        });

        document.getElementById('restoreFromNetworkBtn').addEventListener('click', function() {
            if (confirm('This will restore the local database from the network drive backup. Current local database will be backed up. Continue?')) {
                const btn = this;
                const originalText = btn.innerHTML;
                
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Restoring...';
                
                fetch('/api/database-sync/restore-from-network', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(data.message + (data.warning ? ' ' + data.warning : ''), 'success');
                    } else {
                        showAlert(data.message, 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Failed to restore from network: ' + error.message, 'danger');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
            }
        });

        // Reset functionality with strong safety confirmations
        document.getElementById('resetLocalBtn').addEventListener('click', function() {
            if (confirm(' WARNING: This will delete ALL local data including:\n\n Local database\n Cached photos\n Application logs\n Local settings\n\nThis action is IRREVERSIBLE!\n\nType "RESET LOCAL" to confirm:') && 
                prompt('Type "RESET LOCAL" to confirm this dangerous operation:') === 'RESET LOCAL') {
                
                const btn = this;
                const originalText = btn.innerHTML;
                
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Resetting...';
                
                fetch('/api/database-sync/reset-local-storage', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(data.message + (data.warning ? ' ' + data.warning : ''), 'warning');
                        // Recommend restart
                        if (confirm('Local storage has been reset. Application restart is recommended. Restart now?')) {
                            window.location.reload();
                        }
                    } else {
                        showAlert(data.message, 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Failed to reset local storage: ' + error.message, 'danger');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
            }
        });

        document.getElementById('resetAllBtn').addEventListener('click', function() {
            if (confirm(' EXTREME WARNING: This will delete EVERYTHING including:\n\n ALL photos (local and network)\n Complete database (local and network)\n All API keys and settings\n All logs and cache\n Complete application state\n\nThis will reset the application to factory state!\nThis action is COMPLETELY IRREVERSIBLE!\n\nAre you absolutely sure?') &&
                confirm('This is your FINAL warning!\n\nYou will lose:\n All downloaded photos\n All metadata and tags\n All API keys\n All configuration\n\nEverything will be permanently deleted from both local and network storage.\n\nContinue with complete reset?') &&
                prompt('Type "DELETE EVERYTHING" to confirm this extremely dangerous operation:') === 'DELETE EVERYTHING') {
                
                const btn = this;
                const originalText = btn.innerHTML;
                
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Deleting Everything...';
                
                fetch('/api/database-sync/reset-all-storage', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(data.message + (data.warning ? ' ' + data.warning : ''), 'success');
                        // Force restart after complete reset
                        setTimeout(() => {
                            alert('Complete reset successful. The application will reload now.');
                            window.location.reload();
                        }, 2000);
                    } else {
                        showAlert(data.message, 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Failed to reset all storage: ' + error.message, 'danger');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
            }
        });
        
        // Shutdown application
        document.getElementById('shutdownAppBtn').addEventListener('click', function() {
            if (confirm(' Shutdown Application\n\nThis will gracefully stop the application server. You will need to restart it manually to continue using the application.\n\nThe following will happen:\n Database will be synced to network (if enabled)\n All downloads will be stopped\n Web interface will become unavailable\n Application will exit cleanly\n\nDo you want to shutdown the application?')) {
                
                const btn = this;
                const originalText = btn.innerHTML;
                
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Shutting Down...';
                
                fetch('/settings/shutdown', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(data.message, 'warning');
                        // Show countdown and then redirect to a goodbye page
                        let countdown = 5;
                        const countdownInterval = setInterval(() => {
                            btn.innerHTML = `<i class="bi bi-power"></i> Server stopping in ${countdown}s...`;
                            countdown--;
                            if (countdown < 0) {
                                clearInterval(countdownInterval);
                                // Show final message and then try to detect when server is down
                                document.body.innerHTML = `
                                    <div class="container mt-5">
                                        <div class="row justify-content-center">
                                            <div class="col-md-6 text-center">
                                                <div class="card">
                                                    <div class="card-body py-5">
                                                        <i class="bi bi-power text-danger" style="font-size: 4rem;"></i>
                                                        <h3 class="mt-3">Application Shutdown</h3>
                                                        <p class="text-muted">The Unsplash Downloader has been shut down successfully.</p>
                                                        <p class="text-muted">To use the application again, please restart the server.</p>
                                                        <div class="mt-4">
                                                            <code class="bg-light p-2 rounded">java -jar target/unsplash-downloader-1.0-SNAPSHOT.jar</code>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }, 1000);
                    } else {
                        showAlert(data.message, 'danger');
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    showAlert('Failed to shutdown application: ' + error.message, 'danger');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
            }
        });
        
        // Remove individual recent items
        function removeRecentUsername(button) {
            const username = button.getAttribute('data-username');
            if (confirm(`Remove "${username}" from recent usernames?`)) {
                fetch('/settings/remove-recent-username', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: 'username=' + encodeURIComponent(username)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        button.parentElement.remove();
                        showAlert('Username removed from history', 'success');
                    } else {
                        showAlert('Failed to remove username: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Failed to remove username', 'danger');
                });
            }
        }
        
        function removeRecentPath(button) {
            const path = button.getAttribute('data-path');
            if (confirm(`Remove "${path}" from recent paths?`)) {
                fetch('/settings/remove-recent-path', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: 'path=' + encodeURIComponent(path)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        button.parentElement.remove();
                        showAlert('Path removed from history', 'success');
                    } else {
                        showAlert('Failed to remove path: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Failed to remove path', 'danger');
                });
            }
        }
        
        // Show alert messages
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the main content
            const main = document.querySelector('main');
            main.insertBefore(alertDiv, main.firstChild.nextSibling);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Folder browser functionality
        let currentBrowserPath = '';
        const folderModal = new bootstrap.Modal(document.getElementById('folderModal'));
        const newFolderModal = new bootstrap.Modal(document.getElementById('newFolderModal'));
        
        document.getElementById('browsePathBtn').addEventListener('click', function() {
            const currentPath = document.getElementById('lastOutputPath').value || './';
            browsePath(currentPath);
            folderModal.show();
        });
        
        function browsePath(path) {
            currentBrowserPath = path;
            document.getElementById('currentPath').value = path;
            updateBreadcrumb(path);
            
            // Show loading state
            document.getElementById('folderBrowser').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Loading directories...</div>
                </div>
            `;
            
            fetch('/download/browse?path=' + encodeURIComponent(path))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderFolderBrowser(data);
                } else {
                    showBrowserError('Failed to browse directory: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showBrowserError('Failed to browse directory');
            });
        }
        
        function renderFolderBrowser(data) {
            const browser = document.getElementById('folderBrowser');
            browser.innerHTML = '';
            
            if (data.directories.length === 0) {
                browser.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-folder-x" style="font-size: 2rem;"></i>
                        <div class="mt-2">No subdirectories found</div>
                    </div>
                `;
                return;
            }
            
            // Sort directories alphabetically
            data.directories.sort((a, b) => a.name.localeCompare(b.name));
            
            data.directories.forEach(dir => {
                const item = document.createElement('div');
                item.className = 'folder-item';
                item.innerHTML = `
                    <i class="bi bi-folder"></i>
                    <span>${escapeHtml(dir.name)}</span>
                `;
                item.onclick = () => browsePath(dir.path);
                browser.appendChild(item);
            });
        }
        
        function showBrowserError(message) {
            document.getElementById('folderBrowser').innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                    <div class="mt-2 text-muted">${message}</div>
                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="browsePath(currentBrowserPath)">
                        <i class="bi bi-arrow-clockwise"></i> Retry
                    </button>
                </div>
            `;
        }
        
        function updateBreadcrumb(path) {
            const breadcrumb = document.getElementById('breadcrumbNav');
            breadcrumb.innerHTML = '';
            
            const parts = path.split('/').filter(part => part !== '');
            let currentPath = '';
            
            // Add root
            const rootItem = document.createElement('li');
            rootItem.className = 'breadcrumb-item';
            rootItem.innerHTML = '<a href="#" onclick="browsePath(\'/\')">Root</a>';
            breadcrumb.appendChild(rootItem);
            
            // Add path parts
            parts.forEach((part, index) => {
                currentPath += '/' + part;
                const item = document.createElement('li');
                item.className = 'breadcrumb-item';
                
                if (index === parts.length - 1) {
                    item.className += ' active';
                    item.textContent = part;
                } else {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = part;
                    link.onclick = () => browsePath(currentPath);
                    item.appendChild(link);
                }
                
                breadcrumb.appendChild(item);
            });
        }
        
        // Parent directory navigation
        document.getElementById('parentBtn').addEventListener('click', function() {
            const currentPath = document.getElementById('currentPath').value;
            const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/')) || '/';
            browsePath(parentPath);
        });
        
        // Refresh current directory
        document.getElementById('refreshBtn').addEventListener('click', function() {
            const currentPath = document.getElementById('currentPath').value;
            browsePath(currentPath);
        });
        
        // Select folder
        document.getElementById('selectFolderBtn').addEventListener('click', function() {
            const selectedPath = document.getElementById('currentPath').value;
            document.getElementById('lastOutputPath').value = selectedPath;
            folderModal.hide();
        });
        
        // New folder functionality
        document.getElementById('newFolderBtn').addEventListener('click', function() {
            const currentPath = document.getElementById('currentPath').value;
            document.getElementById('newFolderPath').textContent = currentPath;
            document.getElementById('newFolderName').value = '';
            newFolderModal.show();
        });
        
        document.getElementById('createFolderBtn').addEventListener('click', function() {
            const folderName = document.getElementById('newFolderName').value.trim();
            const currentPath = document.getElementById('currentPath').value;
            
            if (!folderName) {
                showAlert('Please enter a folder name', 'warning');
                return;
            }
            
            // Validate folder name
            if (!/^[a-zA-Z0-9._-]+$/.test(folderName)) {
                showAlert('Folder name can only contain letters, numbers, dots, hyphens, and underscores', 'warning');
                return;
            }
            
            const createBtn = document.getElementById('createFolderBtn');
            createBtn.disabled = true;
            createBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Creating...';
            
            fetch('/download/create-folder', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `parentPath=${encodeURIComponent(currentPath)}&folderName=${encodeURIComponent(folderName)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Folder created successfully!', 'success');
                    newFolderModal.hide();
                    // Refresh the current directory
                    browsePath(currentPath);
                } else {
                    showAlert('Failed to create folder: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to create folder', 'danger');
            })
            .finally(() => {
                createBtn.disabled = false;
                createBtn.innerHTML = '<i class="bi bi-folder-plus"></i> Create Folder';
            });
        });
        
        // Enter key support for folder name input
        document.getElementById('newFolderName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('createFolderBtn').click();
            }
        });
        
        // Auto-focus folder name input when modal opens
        document.getElementById('newFolderModal').addEventListener('shown.bs.modal', function() {
            document.getElementById('newFolderName').focus();
        });
        
        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Metadata Sync Functionality
        let metadataSyncInterval = null;
        
        function loadMetadataSyncStats() {
            fetch('/metadata-sync/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading metadata sync stats:', data.error);
                        return;
                    }
                    
                    // Update overview statistics
                    document.getElementById('totalPhotosInDatabase').textContent = data.totalPhotosInDatabase || 0;
                    document.getElementById('completedCount').textContent = data.completed || 0;
                    document.getElementById('photosDueForSync').textContent = data.photosDueForSync || 0;
                    document.getElementById('photosNotInSync').textContent = data.photosNotInSync || 0;
                    
                    // Update detailed statistics
                    document.getElementById('totalInSync').textContent = data.totalInSync || 0;
                    document.getElementById('pendingCount').textContent = data.pending || 0;
                    document.getElementById('failedCount').textContent = data.failed || 0;
                    document.getElementById('errorCount').textContent = data.error || 0;
                    document.getElementById('skippedCount').textContent = data.skipped || 0;
                    document.getElementById('inProgressCount').textContent = data.syncInProgress ? '1' : '0';
                    
                    // Update progress bars
                    const overallPercentage = data.overallCompletionPercentage || 0;
                    const syncPercentage = data.completionPercentage || 0;
                    document.getElementById('syncProgressBar').style.width = overallPercentage + '%';
                    document.getElementById('overallCompletionPercentage').textContent = overallPercentage.toFixed(1) + '%';
                    document.getElementById('completionPercentage').textContent = syncPercentage.toFixed(1) + '%';
                    
                    // Update status text
                    const syncInProgress = data.syncInProgress || false;
                    const needingSync = data.needingSync || 0;
                    
                    let statusText = 'Ready';
                    if (syncInProgress) {
                        statusText = 'Sync in progress...';
                    } else if (needingSync > 0) {
                        statusText = needingSync + ' photos need syncing';
                    } else if (data.completed > 0) {
                        statusText = 'All photos synced';
                    }
                    
                    document.getElementById('syncStatusText').textContent = statusText;
                    
                    // Update button states
                    const startBtn = document.getElementById('startSyncBtn');
                    const stopBtn = document.getElementById('stopSyncBtn');
                    
                    if (syncInProgress) {
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        startBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';
                    } else {
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                        startBtn.innerHTML = '<i class="bi bi-play-circle"></i> Start Sync';
                    }
                })
                .catch(error => {
                    console.error('Error loading metadata sync stats:', error);
                });
        }
        
        // Initialize metadata sync
        document.getElementById('initializeBtn').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Initializing...';
            
            fetch('/metadata-sync/initialize', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Metadata sync initialized successfully');
                    loadMetadataSyncStats();
                } else {
                    alert('Failed to initialize: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to initialize metadata sync');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-plus-circle"></i> Initialize Sync';
            });
        });
        
        // Start metadata sync
        document.getElementById('startSyncBtn').addEventListener('click', function() {
            const batchSize = document.getElementById('batchSizeSelect').value;
            
            fetch('/metadata-sync/start?batchSize=' + batchSize, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Metadata sync started');
                    // Start polling for updates
                    if (metadataSyncInterval) clearInterval(metadataSyncInterval);
                    metadataSyncInterval = setInterval(loadMetadataSyncStats, 2000);
                    loadMetadataSyncStats();
                } else {
                    alert('Failed to start sync: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to start metadata sync');
            });
        });
        
        // Stop metadata sync
        document.getElementById('stopSyncBtn').addEventListener('click', function() {
            fetch('/metadata-sync/stop', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Stop signal sent to metadata sync');
                    // Stop polling
                    if (metadataSyncInterval) {
                        clearInterval(metadataSyncInterval);
                        metadataSyncInterval = null;
                    }
                    loadMetadataSyncStats();
                } else {
                    alert('Failed to stop sync: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to stop metadata sync');
            });
        });
        
        // Refresh stats
        document.getElementById('refreshStatsBtn').addEventListener('click', function() {
            loadMetadataSyncStats();
        });
        
        // Add new photos to sync system
        document.getElementById('addNewPhotosBtn').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Adding...';
            
            fetch('/metadata-sync/add-new-photos', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('New photos added to sync system');
                    loadMetadataSyncStats(); // Refresh stats
                } else {
                    alert('Failed to add new photos: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error adding new photos:', error);
                alert('Failed to add new photos');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-plus-square"></i> Add New Photos';
            });
        });
        
        // Reset sync entries
        document.getElementById('resetSyncBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to reset all metadata sync entries to pending? This will re-sync all photos.')) {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Resetting...';
                
                fetch('/metadata-sync/reset', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('All sync entries reset to pending');
                        loadMetadataSyncStats();
                    } else {
                        alert('Failed to reset: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to reset sync entries');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Reset All to Pending';
                });
            }
        });
        
        // Cleanup old entries
        document.getElementById('cleanupBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to cleanup completed sync entries older than 30 days?')) {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Cleaning...';
                
                fetch('/metadata-sync/cleanup?daysToKeep=30', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Cleanup completed');
                        loadMetadataSyncStats();
                    } else {
                        alert('Failed to cleanup: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to cleanup entries');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-trash"></i> Cleanup Old Entries';
                });
            }
        });
        
        // Load initial metadata sync stats when page loads
        loadMetadataSyncStats();
    </script>
</body>
</html>